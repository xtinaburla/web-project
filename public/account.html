<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет | Типография Призма</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        /* Ваши стили остаются без изменений */
        /* ... */
    </style>
</head>
<body>
    <!-- Ваша HTML-разметка остается без изменений -->
    <!-- ... -->

    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
    <script>
        // Инициализация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCDurrGed-JcaBRJgEYb2eeM8G-Je-yrWA",
            authDomain: "prisma-print.firebaseapp.com",
            projectId: "prisma-print",
            storageBucket: "prisma-print.appspot.com",
            messagingSenderId: "165546230296",
            appId: "1:165546230296:web:7b816c389d23f5b762396d"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Функция для форматирования даты
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'Дата не указана';
            try {
                const date = timestamp.toDate();
                return date.toLocaleDateString('ru-RU', {
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error("Ошибка форматирования даты:", e);
                return 'Неверный формат даты';
            }
        };

        // Функция для получения названия продукта
        const getProductName = (type) => {
            const names = {
                'visiting-card': 'Визитки',
                'sticker': 'Наклейки',
                'postcard': 'Открытки',
                'booklet': 'Буклеты',
                'magazine': 'Журналы',
                'box': 'Коробки',
                'calendar': 'Календари',
                'notebook': 'Блокноты'
            };
            return names[type] || type;
        };

        // Функция для получения статуса заказа
        const getStatusName = (status) => {
            const statuses = {
                'new': 'Новый',
                'processing': 'В обработке',
                'production': 'В производстве',
                'completed': 'Завершен',
                'shipped': 'Отправлен',
                'cancelled': 'Отменен'
            };
            return statuses[status] || status;
        };

        // Основная функция загрузки данных
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            console.log('Текущий пользователь UID:', user.uid);

            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = '<div class="no-orders"><p>Загрузка ваших заказов...</p></div>';

            try {
                const ordersQuery = db.collection('orders')
                    .where('userId', '==', user.uid)
                    .orderBy('date', 'desc');

                const ordersSnapshot = await ordersQuery.get();
                
                if (ordersSnapshot.empty) {
                    ordersList.innerHTML = `
                        <div class="no-orders">
                            <p>У вас пока нет заказов</p>
                        </div>
                    `;
                    return;
                }

                ordersList.innerHTML = ''; // Очищаем список перед загрузкой

                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    console.log('Заказ из БД:', doc.id, order);

                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                        <div class="order-header">
                            <span class="order-number">Заказ #${doc.id.substring(0, 8)}</span>
                            <span class="order-date">${formatDate(order.date)}</span>
                        </div>
                        <div class="order-details">
                            <p><strong>Тип:</strong> ${order.productName || getProductName(order.productType)}</p>
                            <p><strong>Статус:</strong> <span class="status-${order.status}">${getStatusName(order.status)}</span></p>
                            <p><strong>Сумма:</strong> ${order.price?.toFixed(2) || '0.00'} ₽</p>
                            <p><strong>Количество:</strong> ${order.quantity || '1'}</p>
                        </div>
                    `;
                    ordersList.appendChild(orderItem);
                });

            } catch (error) {
                console.error('Ошибка загрузки заказов:', error);
                ordersList.innerHTML = `
                    <div class="no-orders">
                        <p>Произошла ошибка при загрузке заказов</p>
                        <p>Пожалуйста, попробуйте позже</p>
                    </div>
                `;
            }
        });

        // Выход из системы
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch(error => {
                console.error('Ошибка при выходе:', error);
                alert('Не удалось выйти из системы: ' + error.message);
            });
        });
    </script>
</body>
</html>
